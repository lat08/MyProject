name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Install dependencies
        run: npm install
      
      - name: Run tests
        run: npm test
        continue-on-error: false
      
      - name: Run tests with coverage
        run: npm run test:coverage
        continue-on-error: false
      
      - name: Display test summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Tests completed for Node.js ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          if [ -d "coverage" ]; then
            echo "- Coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Build application
        run: npm run build
        continue-on-error: false
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.node-version }}
          path: coverage/
          retention-days: 7

  deploy-heroku:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history (required by Heroku)
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
      
      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
      
      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
      
      - name: Deploy to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        run: |
          # Heroku CLI automatically uses HEROKU_API_KEY environment variable
          heroku auth:whoami
          
          # Unshallow repository if needed (Heroku requires full git history)
          git fetch --unshallow || true
          
          # Set up git remote with credentials embedded in URL
          # Format: https://:API_KEY@git.heroku.com/APP_NAME.git
          git remote add heroku https://:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git || true
          git remote set-url heroku https://:$HEROKU_API_KEY@git.heroku.com/$HEROKU_APP_NAME.git
          
          # Verify remote is configured
          git remote -v
          
          # Push to Heroku
          git push heroku HEAD:main --force
      
      - name: Set Heroku Config Vars (Secrets)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        continue-on-error: true
        run: |
          # Set environment variables from GitHub secrets
          # Example: Set NODE_ENV
          heroku config:set NODE_ENV=production -a $HEROKU_APP_NAME || true
          
          # Set custom secrets (uncomment and configure as needed)
          # heroku config:set DATABASE_URL="${{ secrets.DATABASE_URL }}" -a $HEROKU_APP_NAME || true
          # heroku config:set API_KEY="${{ secrets.API_KEY }}" -a $HEROKU_APP_NAME || true
          # heroku config:set SECRET_KEY="${{ secrets.SECRET_KEY }}" -a $HEROKU_APP_NAME || true
      
      - name: Run post-deploy commands
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        continue-on-error: true
        run: |
          # Build is already done during deployment, this is optional
          heroku restart -a $HEROKU_APP_NAME || true
      
      - name: Display deployment info
        if: always()
        env:
          HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Application deployed to: https://$HEROKU_APP_NAME.herokuapp.com" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment completed successfully" >> $GITHUB_STEP_SUMMARY